#/bin/bash -l

function run_smmr()
{

	source `find ${gitDir} -name paths.sh`
	source `find ${gitDir} -name utils.sh`
	source `find ${gitDir} -name genome.sh`


	
	local fn_bam=$1
	local fn_bam_IDsortedPrefix=${fn_bam%.bam}_IDsorted
	local fn_bam_smmr_IDsorted=${fn_bam%.bam}_smmr_IDsorted.bam
	local fn_bam_smmr=${fn_bam%.bam}_smmr.bam
	
	echo $fn_bam
	echo $fn_bam_IDsortedPrefix
	
	if [ ! -f $fn_bam_smmr  ]; then
		#__ sort bam file after ID ________________________________________________________________________________________________________________________________________________________
		#----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		$samtools sort -n $fn_bam $fn_bam_IDsortedPrefix
		#___________________________________________________________________________________________________________________________________________________________________________________
		
		#__ invoke mmr ____________________________________________________________________________________________________________________________________________________________________
		#----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		echo "$smmr ${fn_bam_IDsortedPrefix}.bam ${fn_bam_smmr_IDsorted}" # option -cache-all only for non-id-sorted bams
		$smmr ${fn_bam_IDsortedPrefix}.bam ${fn_bam_smmr_IDsorted} -cache-all
		#___________________________________________________________________________________________________________________________________________________________________________________
		
		#__ sort bam file after chromosomes ________________________________________________________________________________________________________________________________________________
		#----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		$samtools sort ${fn_bam_smmr_IDsorted} ${fn_bam_smmr%.bam}
		rm ${fn_bam_smmr_IDsorted}
		rm ${fn_bam_IDsortedPrefix}.bam
		#___________________________________________________________________________________________________________________________________________________________________________________
		
		#__ Create an index of the new bam file ___________________________________________________________________________________________________________________________________________
		#----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		$samtools index $fn_bam_smmr
		#___________________________________________________________________________________________________________________________________________________________________________________
	fi
}
